<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diário de Classe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app" class="container mx-auto p-4">
    <!-- Tela de Login -->
    <div id="loginScreen" class="max-w-md mx-auto mt-10">
      <form id="loginForm" class="space-y-4">
        <input type="email" id="email" placeholder="E-mail" required class="w-full p-2 border rounded">
        <input type="password" id="password" placeholder="Senha" required class="w-full p-2 border rounded">
        <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded">Entrar</button>
      </form>
    </div>

    <!-- Tela Principal -->
    <div id="mainScreen" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Diário de Classe</h1>
        <button id="logoutBtn" class="text-red-500">Sair</button>
      </div>
      
      <!-- Formulário de Nova Anotação -->
      <form id="entryForm" class="mb-8 space-y-4">
        <!-- Campos do formulário aqui -->
      </form>

      <!-- Lista de Anotações -->
      <div id="entriesList" class="space-y-4"></div>
    </div>
  </div>

  <script type="module">
    import { AuthManager } from './auth.js';
    import { ClassDiary } from './diary.js';
    import { auth } from './firebase.js';

    // Controle de UI
    const loginScreen = document.getElementById('loginScreen');
    const mainScreen = document.getElementById('mainScreen');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const entryForm = document.getElementById('entryForm');
    const entriesList = document.getElementById('entriesList');

    // Gerenciamento de Estado
    let currentUser = null;
    let unsubscribeEntries = null;

    // Event Listeners
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      try {
        await AuthManager.login(email, password);
      } catch (error) {
        alert('Erro no login: ' + error.message);
      }
    });

    logoutBtn.addEventListener('click', () => AuthManager.logout());

    entryForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const entryData = {
        date: document.getElementById('date').value,
        class: document.getElementById('class').value,
        subject: document.getElementById('subject').value,
        content: document.getElementById('content').value,
        homework: document.getElementById('homework').value,
        observations: document.getElementById('observations').value,
        teacherId: currentUser.uid,
        createdAt: new Date().toISOString()
      };

      await ClassDiary.addEntry(entryData);
      entryForm.reset();
    });

    // Monitora estado de autenticação
    AuthManager.onAuthChange((user) => {
      currentUser = user;
      if (user) {
        loginScreen.classList.add('hidden');
        mainScreen.classList.remove('hidden');
        loadEntries();
      } else {
        loginScreen.classList.remove('hidden');
        mainScreen.classList.add('hidden');
        if (unsubscribeEntries) unsubscribeEntries();
      }
    });

    // Carrega anotações em tempo real
    function loadEntries() {
      unsubscribeEntries = ClassDiary.subscribeToEntries(currentUser.uid, (entries) => {
        entriesList.innerHTML = entries.map(entry => `
          <div class="p-4 border rounded-lg">
            <h3 class="font-bold">${entry.subject} - ${entry.class}</h3>
            <p>${entry.content}</p>
            <button onclick="deleteEntry('${entry.id}')" class="text-red-500 mt-2">Excluir</button>
          </div>
        `).join('');
      });
    }

    // Função global para deletar
    window.deleteEntry = async (id) => {
      if (confirm('Tem certeza?')) await ClassDiary.deleteEntry(id);
    };
  </script>
</body>
</html>