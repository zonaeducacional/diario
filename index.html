import { 
    auth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged,
    updateProfile,
    sendPasswordResetEmail
} from "./firebase.js";

export class AuthManager {
    constructor() {
        this.currentUser = null;
        this.initAuthListeners();
        this.bindAuthUIEvents();
    }

    initAuthListeners() {
        // Observa mudanças no estado de autenticação
        onAuthStateChanged(auth, (user) => {
            this.currentUser = user;
            const authScreen = document.getElementById('authScreen');
            const mainContent = document.getElementById('mainContent');
            
            if (user) {
                // Usuário autenticado
                authScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                console.log("Usuário logado:", user.email);
            } else {
                // Usuário não autenticado
                authScreen.classList.remove('hidden');
                mainContent.classList.add('hidden');
            }
        });
    }

    bindAuthUIEvents() {
        // Alternar entre login e registro
        document.getElementById('loginTab').addEventListener('click', () => {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginTab').classList.add('border-blue-500', 'text-blue-600');
            document.getElementById('loginTab').classList.remove('text-gray-500');
            document.getElementById('registerTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('registerTab').classList.add('text-gray-500');
        });

        document.getElementById('registerTab').addEventListener('click', () => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('registerTab').classList.add('border-blue-500', 'text-blue-600');
            document.getElementById('registerTab').classList.remove('text-gray-500');
            document.getElementById('loginTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('loginTab').classList.add('text-gray-500');
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                this.showMessage('Login realizado com sucesso!', 'success');
            } catch (error) {
                this.handleAuthError(error);
            }
        });

        // Registro
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirmPassword) {
                this.showMessage('As senhas não coincidem!', 'error');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                this.showMessage('Conta criada com sucesso!', 'success');
                // Volta para o login após registro
                document.getElementById('loginTab').click();
            } catch (error) {
                this.handleAuthError(error);
            }
        });

        // Esqueceu a senha
        document.getElementById('forgotPassword').addEventListener('click', async () => {
            const email = prompt("Digite seu e-mail para redefinir a senha:");
            if (email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    this.showMessage('E-mail de redefinição enviado! Verifique sua caixa de entrada.', 'success');
                } catch (error) {
                    this.handleAuthError(error);
                }
            }
        });
    }

    handleAuthError(error) {
        console.error("Erro de autenticação:", error.code, error.message);
        
        let message = "Erro ao autenticar";
        switch (error.code) {
            case 'auth/invalid-login-credentials':
            case 'auth/wrong-password':
                message = "E-mail ou senha incorretos";
                document.getElementById('loginPassword').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('loginPassword').classList.remove('shake');
                }, 500);
                break;
            case 'auth/user-not-found':
                message = "Usuário não encontrado";
                break;
            case 'auth/email-already-in-use':
                message = "E-mail já está em uso";
                break;
            case 'auth/weak-password':
                message = "Senha muito fraca (mínimo 6 caracteres)";
                break;
            case 'auth/too-many-requests':
                message = "Muitas tentativas. Tente novamente mais tarde";
                break;
            default:
                message = error.message;
        }
        
        this.showMessage(message, 'error');
    }

    showMessage(text, type) {
        const messageDiv = document.getElementById('authMessage');
        messageDiv.textContent = text;
        messageDiv.classList.remove('hidden', 'text-red-500', 'text-green-500');
        messageDiv.classList.add(type === 'error' ? 'text-red-500' : 'text-green-500');
        
        setTimeout(() => {
            messageDiv.classList.add('hidden');
        }, 5000);
    }

    async logout() {
        try {
            await signOut(auth);
            this.showMessage('Logout realizado com sucesso', 'success');
        } catch (error) {
            this.handleAuthError(error);
        }
    }
}

// Inicializa o gerenciador de autenticação
new AuthManager();
